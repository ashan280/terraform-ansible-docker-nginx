name: CI/CD - Terraform + Ansible (AWS EC2 + Docker + Nginx)

on:
  push:
    branches:
      - main  # Trigger the workflow on every push to main branch

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy Web App to AWS EC2
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}

    steps:
      ###########################################################################
      # 1. Checkout Repository
      ###########################################################################
      - name: Checkout Repository
        uses: actions/checkout@v4

      ###########################################################################
      # 2. Setup Terraform
      ###########################################################################
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.8

      ###########################################################################
      # 3. Configure AWS Credentials
      ###########################################################################
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      ###########################################################################
      # 4. Initialize Terraform (Optional)
      # If EC2 is manually created, this step is harmless and idempotent
      ###########################################################################
      - name: Terraform Init
        run: terraform init

      - name: Terraform Apply (idempotent)
        run: terraform apply -auto-approve || echo "Terraform skipped if EC2 already exists"

      ###########################################################################
      # 5. Set EC2 IP (from GitHub Secret if static)
      ###########################################################################
      - name: Load EC2 IP from GitHub Secrets
        id: get_ip
        run: |
          echo "EC2_IP=${{ secrets.EC2_STATIC_IP }}" >> $GITHUB_ENV
          echo "‚úÖ Using EC2 Public IP: ${{ secrets.EC2_STATIC_IP }}"

      ###########################################################################
      # 6. Setup Python and Ansible
      ###########################################################################
      - name: Setup Python & Install Ansible
        run: |
          sudo apt update -y
          sudo apt install -y python3 python3-pip gettext-base
          pip3 install ansible boto3 botocore
          ansible --version
          echo "‚úÖ Ansible installed successfully"

      ###########################################################################
      # 7. Prepare Ansible Inventory (Dynamic IP injection)
      ###########################################################################
      - name: Generate Ansible Inventory
        run: |
          mkdir -p ansible
          envsubst < ansible/inventory.tpl > ansible/inventory.ini
          echo "‚úÖ Generated inventory file:"
          cat ansible/inventory.ini

      ###########################################################################
      # 8. Setup SSH Key for EC2 Access
      ###########################################################################
      - name: Setup SSH Key for Ansible
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > Network.pem
          chmod 400 Network.pem
          echo "‚úÖ SSH key configured successfully"

      ###########################################################################
      # 9. Run Ansible Playbooks (Docker + Nginx + HTML)
      ###########################################################################
      - name: Install Docker on EC2
        run: |
          ansible-playbook -i ansible/inventory.ini ansible/install-docker.yml

      - name: Deploy Nginx Container and HTML Content
        run: |
          ansible-playbook -i ansible/inventory.ini ansible/deploy-nginx.yml

      ###########################################################################
      # 10. Display Deployment Info
      ###########################################################################
      - name: Display Deployment Information
        run: |
          echo "‚úÖ Deployment Completed Successfully!"
          echo "üåç Visit your site at: http://${{ env.EC2_IP }}"
